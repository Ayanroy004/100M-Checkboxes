<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>1 Thousand Checkbox</title>
    <style>
                      * {
                        box-sizing: border-box;
                      }

                      body {
                        font-family: 'Segoe UI', sans-serif;
                        margin: 0;
                        padding: 0;
                        background: #f0f2f5;
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        /* height: 100vh; */
                      }

                      .checkbox-container {
                        background: white;
                        padding: 2rem;
                        border-radius: 12px;
                        box-shadow: 0 0 10px rgba(0,0,0,0.1);
                        width: 90%;
                        /* max-width: 600px; */
                      }

                      h1 {
                        margin-top: 0;
                        text-align: center;
                        color: #333;
                      }

                      p {
                        text-align: center;
                        font-size: 1.1rem;
                      }

                      #checkboxes {
                        display: grid;
                        grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
                        gap: 10px;
                        margin: 1rem 0;
                        padding: 10px;
                        border: 1px solid #ddd;
                        border-radius: 8px;
                        background: #fafafa;
                      }

          input[type="checkbox"] {
            width: 20px;
            height: 20px;
             pointer-events: none;         /* Prevent interaction */
      accent-color: #ff4d4f;        /* Your custom color */
                        /* No graying */
      /* cursor: not-allowed; */
          }




                      #total-checked {
                        font-weight: bold;
                        color: #007bff;
                      }

                      .clear-btn {
                        display: block;
                        margin: 1rem auto 0;
                        padding: 0.6rem 1.2rem;
                        background-color: #dc3545;
                        color: white;
                        border: none;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 1rem;
                        transition: background 0.3s;
                      }

                      button:hover {
                        background-color: #c82333;
                      }
                      .connect-container{
                        display: flex;
                        justify-content: end;
                        align-items: center;
                        gap: 10px;
                        height: 65px;
                      }
                      .connect-container input{
                        height: 30px;
                        padding-left: 10px;
                        border: 1px solid brown;
                        border-radius: 5px;
                        /* background-color: #c82333; */
                        outline: none;
                      }
                      .connect-container button{
                        background-color: rgb(170, 43, 8);
                        color: #FFFFFF;
                        border: none;
                        border-radius: 10px;
                        padding: 8px;
                      }
                      .connect-container button:hover{
                        background-color: rgba(170, 43, 8, 0.833);
                      }
                      .connect-container button:disabled{
                        opacity: 0.5;
                        cursor: not-allowed;
                      }
    </style>
  </head>
  <body>
    <div class="checkbox-container">
      <h1>1 Thousand Checkbox</h1>
      <p>Check the boxes to Connect Real Time Server ðŸ˜€</p>
      <p>Total Checked: <span id="total-checked">0</span></p>

      <div class="connect-container">
        <button class="discon" onclick="handelDisconnect()">Disconnect</button>
        <!-- <h4 class="show-userName"></h4> -->
        <input id="name" type="text" placeholder="Enter your name..." />
        <button id="connect" onclick="handelSubmitUserName()">Connect</button>
      </div>
      <div id="checkboxes">
        <p style="grid-column: 1 / -1; text-align: center;">Loading...</p>
      </div>
      <!-- <button class="clear-btn" onclick="clearData()">Clear All</button> -->
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();


            socket.on("noCheckbox", (data)=>{
              alert(data.message);
            })
          const clearData = () => {
              localStorage.removeItem("token");
              localStorage.removeItem("user");
            socket.emit("clear");
            const connectBtn = document.querySelector("#connect");
              const inputName = document.querySelector("#name");
              inputName.disabled = false;
              connectBtn.disabled = false;
              inputName.value = "";
              // document.querySelector(".show-userName").innerText = "";
            console.log("Clear data before state update ")
            stateUpdate();
            console.log("Clear data after state update ")

              // document.querySelector(".discon").style="display:none"
          };
          async function handelDisconnect (){
            const token = localStorage.getItem("token");
            const user = localStorage.getItem("user");
            if(!token || !user){
              await alert("Please connect first");

              return;
            }
            socket.emit("userDisconnect");
            localStorage.removeItem("token");
            localStorage.removeItem("user");
            const connectBtn = document.querySelector("#connect");
              const inputName = document.querySelector("#name");
              inputName.disabled = false;
              connectBtn.disabled = false;
              inputName.value = "";
              document.querySelector(".show-userName").innerText = "";
              document.querySelector(".discon").style="display:none"
          }

          socket.on("userDisconnected", (data)=>{
            console.log("User disconnected : ", data);
            stateUpdate();
          })
          function handelSubmitUserName() {
            const getUserValue = document.querySelector("#name");
            const showUserName = document.querySelector(".show-userName");
            console.log("User done", getUserValue.value);
            if (getUserValue.value !== "") {
              const connectBtn = document.querySelector("#connect");
              connectBtn.disabled = true;

              const inputName = document.querySelector("#name");
              inputName.disabled = true;

              socket.emit("userConnected", getUserValue.value);
              // showUserName.innerText = getUserValue.value;
              getUserValue.value = "";
            }

          }
          function renderCheckbox(cachedParseData) {
            const checkboxesContainer = document.getElementById("checkboxes");
            checkboxesContainer.innerHTML = "";
            cachedParseData.forEach((item, index) => {
              const label = document.createElement("label");
              const checkbox = document.createElement("input");
              checkbox.type = "checkbox";
              checkbox.checked = item;
              // checkbox.checked = disable
              // checkbox.disabled = true
              checkbox.id = `checkbox-${index}`;
              // label.appendChild(checkbox);
              checkboxesContainer.appendChild(checkbox);
            });

          }

          async function stateUpdate() {
            const token = localStorage.getItem("token");
            if (token) {
              console.log("User Name found in localStorage");
              document.querySelector(".discon").style="display:block"

              console.log("User Name : ", token.trim());
              const existUser = await fetch("/check-user",
              {headers: {
                'Authorization': token.trim(),
                "Content-Type": "application/json",
              },})
              console.log("existUser done ");
              const userData = await existUser.json();
              console.log("User Data : ", userData);
              // localStorage.setItem("user", userData.user);
              const connectBtn = document.querySelector("#connect");
              const inputName = document.querySelector("#name");
              inputName.value = userData.user;
              inputName.disabled = true;
              connectBtn.disabled = true;
            }else{
              console.log("User Name not found in localStorage");
              document.querySelector(".discon").style="display:none"

            }
            const checkBoxes = await fetch("/state", {
              headers: {
                "Content-Type": "application/json",
              },
            });

            const jsonData = await checkBoxes.json();
            const { cachedParseData, totalTic } = jsonData;
            console.log("Frontend table : ", cachedParseData);
            console.log("Frontend count : ", totalTic);
            document.querySelector("#total-checked").innerText = totalTic || 0;
            if (cachedParseData) {
              renderCheckbox(cachedParseData);
            } else {
              renderCheckbox(jsonData);
            }
          }


      socket.on("saveUser", (some)=>{
            const {name, jwt} = some
            localStorage.setItem("token", jwt);
            localStorage.setItem("user", name);
          })

          socket.on("userDisconnectedDone", (data) => {
            const checkbox = document.getElementById(`checkbox-${data.index}`);
            checkbox.checked = false;
            document.querySelector("#total-checked").innerText = data.count || 0;

          });

          socket.on("userConnectedDone", (data) => {
            const checkbox = document.getElementById(`checkbox-${data.index}`);
            if (data.flag === 1) {
            localStorage.removeItem("token");
            localStorage.removeItem("user");
             const connectBtn = document.querySelector("#connect");
              const inputName = document.querySelector("#name");
              inputName.disabled = false;
              connectBtn.disabled = false;
              inputName.value = "";
              renderCheckbox(data.checkbox);
              document.querySelector(".discon").style="display:none"

            } else {
              checkbox.checked = true;
              const userName = localStorage.getItem("user");
             document.querySelector("#name").value = userName;

            }
            document.querySelector("#total-checked").innerText = data.count || 0;
            const token = localStorage.getItem("token");
            if(token){
            document.querySelector(".discon").style="display:block"
            }
          });

          stateUpdate();
    </script>
  </body>
</html>
