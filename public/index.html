<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="./style/global.css" />
    <title>1 Thousand Checkbox</title>
  </head>
  <body>
    <div class="checkbox-container">
      <h1>1 Thousand Checkbox</h1>
      <p>Check the boxes to Connect Real Time Server ðŸ˜€</p>
      <p>Total Checked: <span id="total-checked">0</span></p>

      <div class="connect-container">
        <!-- <h4 class="show-userName"></h4> -->
        <input id="name" type="text" placeholder="Enter your name..." />
        <div class="button-container">
          <button id="connect" onclick="handelSubmitUserName()">Connect</button>
          <button class="discon" onclick="handelDisconnect()">
            Disconnect
          </button>
        </div>
      </div>
      <div id="checkboxes">
        <p style="grid-column: 1 / -1; text-align: center;">Loading...</p>
      </div>
      <!-- <button class="clear-btn" onclick="clearData()">Clear All</button> -->
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();


            socket.on("noCheckbox", (data)=>{
              alert(data.message);
            })
          const clearData = () => {
              localStorage.removeItem("token");
              localStorage.removeItem("user");
            socket.emit("clear");
            const connectBtn = document.querySelector("#connect");
              const inputName = document.querySelector("#name");
              inputName.disabled = false;
              connectBtn.disabled = false;
              inputName.value = "";
              // document.querySelector(".show-userName").innerText = "";
            console.log("Clear data before state update ")
            stateUpdate();
            console.log("Clear data after state update ")

              // document.querySelector(".discon").style="display:none"
          };
          async function handelDisconnect (){
            const token = localStorage.getItem("token");
            const user = localStorage.getItem("user");
            if(!token || !user){
              await alert("Please connect first");

              return;
            }
            socket.emit("userDisconnect");
            localStorage.removeItem("token");
            localStorage.removeItem("user");
            const connectBtn = document.querySelector("#connect");
              const inputName = document.querySelector("#name");
              inputName.disabled = false;
              connectBtn.disabled = false;
              inputName.value = "";
              document.querySelector(".show-userName").innerText = "";
              document.querySelector(".discon").style="display:none"
          }

          socket.on("userDisconnected", (data)=>{
            console.log("User disconnected : ", data);
            stateUpdate();
          })
          function handelSubmitUserName() {
            const getUserValue = document.querySelector("#name");
            const showUserName = document.querySelector(".show-userName");
            console.log("User done", getUserValue.value);
            if (getUserValue.value !== "") {
              const connectBtn = document.querySelector("#connect");
              connectBtn.disabled = true;

              const inputName = document.querySelector("#name");
              inputName.disabled = true;

              socket.emit("userConnected", getUserValue.value);
              // showUserName.innerText = getUserValue.value;
              getUserValue.value = "";
            }

          }
          function renderCheckbox(cachedParseData) {
            const checkboxesContainer = document.getElementById("checkboxes");
            checkboxesContainer.innerHTML = "";
            cachedParseData.forEach((item, index) => {
              const label = document.createElement("label");
              const checkbox = document.createElement("input");
              checkbox.type = "checkbox";
              checkbox.checked = item;
              // checkbox.checked = disable
              // checkbox.disabled = true
              checkbox.id = `checkbox-${index}`;
              // label.appendChild(checkbox);
              checkboxesContainer.appendChild(checkbox);
            });

          }

          async function stateUpdate() {
            const token = localStorage.getItem("token");
            if (token) {
              console.log("User Name found in localStorage");
              document.querySelector(".discon").style="display:block"

              console.log("User Name : ", token.trim());
              const existUser = await fetch("/check-user",
              {headers: {
                'Authorization': token.trim(),
                "Content-Type": "application/json",
              },})
              console.log("existUser done ");
              const userData = await existUser.json();
              console.log("User Data : ", userData);
              // localStorage.setItem("user", userData.user);
              const connectBtn = document.querySelector("#connect");
              const inputName = document.querySelector("#name");
              inputName.value = userData.user;
              inputName.disabled = true;
              connectBtn.disabled = true;
            }else{
              console.log("User Name not found in localStorage");
              document.querySelector(".discon").style="display:none"

            }
            const checkBoxes = await fetch("/state", {
              headers: {
                "Content-Type": "application/json",
              },
            });

            const jsonData = await checkBoxes.json();
            const { cachedParseData, totalTic } = jsonData;
            console.log("Frontend table : ", cachedParseData);
            console.log("Frontend count : ", totalTic);
            document.querySelector("#total-checked").innerText = totalTic || 0;
            if (cachedParseData) {
              renderCheckbox(cachedParseData);
            } else {
              renderCheckbox(jsonData);
            }
          }


      socket.on("saveUser", (some)=>{
            const {name, jwt} = some
            localStorage.setItem("token", jwt);
            localStorage.setItem("user", name);
          })

          socket.on("userDisconnectedDone", (data) => {
            const checkbox = document.getElementById(`checkbox-${data.index}`);
            checkbox.checked = false;
            document.querySelector("#total-checked").innerText = data.count || 0;

          });

          socket.on("userConnectedDone", (data) => {
            const checkbox = document.getElementById(`checkbox-${data.index}`);
            if (data.flag === 1) {
            localStorage.removeItem("token");
            localStorage.removeItem("user");
             const connectBtn = document.querySelector("#connect");
              const inputName = document.querySelector("#name");
              inputName.disabled = false;
              connectBtn.disabled = false;
              inputName.value = "";
              renderCheckbox(data.checkbox);
              document.querySelector(".discon").style="display:none"

            } else {
              checkbox.checked = true;
              const userName = localStorage.getItem("user");
             document.querySelector("#name").value = userName;

            }
            document.querySelector("#total-checked").innerText = data.count || 0;
            const token = localStorage.getItem("token");
            if(token){
            document.querySelector(".discon").style="display:block"
            }
          });

          stateUpdate();
    </script>
  </body>
</html>
